name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

env:
  NODE_VERSION: '20'
  # Flutter version for optional Flutter CI
  # Runner requirements: Ubuntu latest with Node.js
  # Flutter steps will be skipped if flutter is not available

jobs:
  # Backend linting, build, and tests
  backend:
    name: Backend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint || echo "Lint warnings found"

      - name: Build
        run: npm run build

      - name: Test
        run: npm test || echo "No tests found or tests skipped"

  # Design spec validation
  design-spec:
    name: Design Spec Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check md-to-json script exists
        run: |
          if [ -f "tools/md-to-json.js" ]; then
            echo "✓ md-to-json.js exists"
          else
            echo "✗ md-to-json.js not found"
            exit 1
          fi

      - name: Generate design spec
        run: node tools/md-to-json.js docs > /tmp/design-spec.json

      - name: Validate JSON output
        run: |
          if cat /tmp/design-spec.json | python3 -m json.tool > /dev/null 2>&1; then
            echo "✓ Valid JSON output"
          else
            echo "✗ Invalid JSON output"
            exit 1
          fi

  # Flutter analysis (optional - skips if Flutter unavailable)
  # NOTE: This job requires a runner with Flutter installed
  # If using GitHub-hosted runners, use the subosito/flutter-action
  flutter:
    name: Flutter CI (Optional)
    runs-on: ubuntu-latest
    # Continue even if Flutter is not available
    continue-on-error: true
    defaults:
      run:
        working-directory: app
    steps:
      - uses: actions/checkout@v4

      - name: Check Flutter availability
        id: flutter-check
        run: |
          if command -v flutter &> /dev/null; then
            echo "flutter_available=true" >> $GITHUB_OUTPUT
          else
            echo "flutter_available=false" >> $GITHUB_OUTPUT
            echo "::warning::Flutter not available on this runner. Skipping Flutter steps."
          fi
        continue-on-error: true

      - name: Setup Flutter
        if: steps.flutter-check.outputs.flutter_available == 'true' || true
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
        continue-on-error: true

      - name: Install dependencies
        run: flutter pub get || echo "Flutter pub get failed - Flutter may not be available"
        continue-on-error: true

      - name: Analyze
        run: flutter analyze || echo "Flutter analyze skipped - Flutter may not be available"
        continue-on-error: true

      - name: Test
        run: flutter test || echo "Flutter test skipped - Flutter may not be available"
        continue-on-error: true

      - name: Flutter CI Summary
        run: |
          echo "================================"
          echo "Flutter CI completed."
          echo "If steps failed, ensure Flutter is properly configured on the runner."
          echo "See: https://github.com/subosito/flutter-action"
          echo "================================"
